# 虚拟内存 #

1. 虚拟内存（VM），是硬件异常、硬件地址翻译、主存、磁盘文件和内核软件的完美交互，它为每个进程提供了一个大的、一致的和私有的地址空间。

## 物理和虚拟寻址 ##

1. 计算机系统的主存被组织成一个由M个连续的字节大小的单元组成的数组，每字节都有一个唯一的物理地址。物理寻址就是指使用物理地址在内存中读取数据。

2. 虚拟寻址，CPU通过生成一个虚拟地址来访问主存，虚拟地址在被送到内存之前先转换成适当的物理地址。将一个虚拟地址转换为物理地址的任务叫做地址翻译。CPU专用硬件**内存管理单元（MMU）**，利用存放在主存中的查询表来动态翻译虚拟地址，该表的内容由操作系统管理。

## 地址空间 ##

1. 连续的地址空间称为线性地址空间。一个地址空间的大小是由标示最大地址所需要的位数来描述的，一个包含$$N=2^n$$个地址的虚拟地址空间就叫做一个n位地址空间。

## 虚拟内存做为缓存的工具 ##

1. VM系统通过将虚拟内存分割为称为**虚拟页**的大小固定的块来处理这个问题。每个虚拟页的大小为$$P=2^p$$字节。物理内存被分割为**物理页**，大小也为P字节（被称为页帧）。在任意时刻，虚拟页面的集合都分为三个不相交的子集：
    - 未分配的，VM系统还未分配（或者创建）的页。
    - 缓存的，当前已缓存在物理内存中的已分配页。
    - 未缓存的，未缓存在物理内存中的已分配页。

2. 由于大的不命中处罚和访问第一个字节的开销，虚拟页往往很大（4KB～2MB）。DRAM缓存是全相联的，即任何虚拟页都可以放置在任何的物理页中。DRAM缓存总是使用写回，而不是直写。

3. 存放在物理内存中叫做**页表**的数据结构，将虚拟页映射到物理页。页表就是一个页表条目（PTE）的数组。虚拟地址空间中的每个页在页表中一个固定偏移量处都有一个PTE。

4. 局部性原则抱枕改了在任意时刻，程序将趋向于在一个较小的活动页面集合上工作，这个集合叫做工作集或者常驻集合。没有展现良好的时间局部性的程序，如果工作集的大小超出了物理内存的大小，那么程序将发生抖动，这时页面将不断地换进换出。

## 虚拟内存作为内存管理工具 ##

1. 操作系统为每个进程提供了一个独立的页表，因而页就是一个独立的虚拟地址空间。多个虚拟页面可以映射到同一个共享物理页面上。

2. 按需页面调度和独立的虚拟地址空间的结合，使VM简化了链接和加载、代码和数据共享，以及应用程序的内存分配：
    - 简化链接，独立的地址空间允许每个进程的内存映像使用相同的基本格式，而不管代码和数据实际存放在物理内存的何处。例如对于64位地址空间，代码段总是从虚拟地址0x400000开始。
    - 简化加载，虚拟内存为代码和数据段分配虚拟页，把它们标记为无效的（即未被缓存的），将页表条目指向目标文件中适当的位置。加载器从不从磁盘到内存实际复制任何数据。将一组连续的虚拟页映射到任意一个文件中的任意位置的表示法称作**内存映射**。
    - 简化共享，独立地址空间为操作系统提供了一个管理用户进程和操作系统自身之间共享的一致机制。操作系统通过将不同进程中适当的虚拟页面映射到相同的物理页面，从而安排多个进程共享这部分代码的一个副本。
    - 简化内存分配，虚拟内存为向用户进程提供一个简单的分配额外内存的机制，操作系统分配一个适当数字（k）个连续的虚拟内存页面，并且将它们映射到物理内存中任意位置的k个任意的物理页面。

## 虚拟内存做为内存保护工具 ##

1. 用额外的许可位来控制对一个虚拟页面内容的访问，如果一条指令违反了这些许可条件，那么CPU就触发一个一般保护故障，将控制传递给一个内核中的异常处理程序。（段错误segmentation fault）

## 地址翻译 ##

