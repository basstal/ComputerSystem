# 链接 #

1. 链接器使得软件开发中**分离编译**成为可能，可以将大型的应用程序组织成更小、更好管理的模块，独立地修改和编译这些模块。

## 编译器驱动程序 ##

## 静态链接 ##

1. **静态链接器**以一组可重定位目标文件和命令行参数作为输入，生成一个完全链接的、可以加载和运行的可执行目标文件作为输出。

2. 链接器必须完成两个主要任务：
    - 符号解析，将每个符号引用（对应一个函数、一个全局变量或一个静态变量）关联到一个符号定义。
    - 重定位，链接器通过把每个符号定义与一个内存位置关联起来，从而重定位这些节，然后修改所有对这些符号的引用，使得它们指向这个内存位置。

## 目标文件 ##

1. 目标文件有三种形式：
    - 可重定位目标文件。可与其他可重定位目标文件合并起来，创建可执行目标文件。
    - 可执行目标文件。可以被直接复制到内存并执行。
    - 共享目标文件。特殊类型的可重定位目标文件，可以在加载或运行时被动态地加载进内存并链接。

## 可重定位目标文件 ##

1. 一个典型的ELF可重定位目标文件包含下面几个节：
    - .text     已编译程序的机器代码。
    - .rodata   只读数据（例如switch跳转表和printf中格式化字符串）。
    - .data     已初始化的全局和静态C变量。
    - .bss      未初始化的静态C变量，以及所有被初始化为0的全局或静态变量。
    - .symtab   符号表，存放在程序中定义和引用的函数和全局变量的信息。
    - .rel.text 一个.text节中位置的列表，当链接器把这个目标文件和其他文件组合时，需要修改这些位置。
    - .rel.data 被模块引用或定义的所有全局变量的重定位信息。
    - .debug    调试符号表，其条目是程序中定义的局部变量和类型定义，只有-g才会得到这张表。
    - .line     原始C源程序中的行号和.text节中机器指令之间的映射，只有-g才会得到这张表。
    - .strtab   字符串表，其内容包括.symtab和.debug节中的符号表，以及节头部中的节名字。

## 符号和符号表 ##

1. 每个可重定位目标模块都有一个符号表，在链接器的上下文中，有三种不同的符号：
    - 由自己定义并能被其他模块引用的全局符号。对应于非静态的C函数和全局变量。
    - 由其他模块定义并被自己引用的全局符号。称为外部符号，对应其他模块中定义的非静态C函数和全局变量。
    - 只被自己定义和引用的局部符号。对应带static属性的C函数和全局变量。在自己模块中任何位置都可见，但是不能被其他模块引用。

2. .symtab中的符号表不包含对应于本地非静态程序变量的任何符号。这些符号在运行时在栈中被管理。

3. ELF符号表条目：
    - int name          字符串表中的字节偏移，指向符号的以null结尾的字符串名字。
    - char type：4      通常要么是数据，要么是函数。
    - char binding：4   表示符号是本地的还是全局的。
    - char reserved     未使用。
    - short section     每个符号都被分配到目标文件的某个节，section字段是一个到节头部表的索引，有三个特殊的伪节，ABS代表不该被重定位的符号；UNDEF代表未定义的符号（在本目标模块中引用但是在其他地方定义的符号）；COMMON表示还未被分配位置的未初始化的数据目标（对于COMMON，value给出对齐要求，size给出最小大小），这些伪节只在可重定位目标文件中才有。
    - long value        是距定义目标的节的起始位置的偏移。对于可执行目标文件，是一个绝对运行时地址。
    - long size         目标的大小（以字节为单位）。

## 符号解析 ##

1. 链接器解析符号引用的方法是将每个引用与它输入的可重定位目标文件的符号表中的一个确定的符号定义关联起来。对那些和引用定义在相同模块中的局部符号的引用，编译器只允许每个模块中每个局部符号有一个定义。

2. 当编译器遇到一个不是在当前模块中定义的符号时，会假设该符号是在其他某个模块中定义的，生成一个链接器符号表条目，并把它交给链接器处理。

3. Linux采用强（函数和已初始化的全局变量）或者弱（未初始化的全局变量）规则：
    - 不允许有多个同名的强符号。
    - 如果有一个强符号和多个弱符号同名，那么选择强符号。
    - 如果有多个弱符号同名，任意选择一个。

4. 编译系统提供一种机制，将所有相关的目标模块打包成为一个单独的文件，称为**静态库**，它可以用作链接器的输入，只复制静态库里被应用程序引用的目标模块到可执行文件中。

## 重定位 ##

1. 